---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Setup
```{r message=FALSE, warning=FALSE}
# Source files and packages
source(here::here("R/_setup.R"))
```

# Load Data
```{r}
load_or_save_latest_file("nfi_dataset_for_analysis", "load")
df <- nfi_dataset_for_analysis
```

# Extract coords
```{r}
df_xy    <- df |> select(lat, lon) |> distinct() |> mutate(site_name = row)
df_years <- df |> select(cam)
```

# Get data from GEE

## Working Code to get NDVI from Uganda
TODO: Adjust and test for France!

```{r}
# Example from ?ee_image_to_drive
## Not run: 
library(rgee)
library(stars)
library(sf)

# ee_users()
ee_Initialize(drive = TRUE)

# Define study area (local -> earth engine)
# Communal Reserve Amarakaeri - Peru
rlist <- list(xmin = -71.13, xmax = -70.95,ymin = -12.89, ymax = -12.73)
ROI <- c(rlist$xmin, rlist$ymin,
         rlist$xmax, rlist$ymin,
         rlist$xmax, rlist$ymax,
         rlist$xmin, rlist$ymax,
         rlist$xmin, rlist$ymin)

ee_ROI <- matrix(ROI, ncol = 2, byrow = TRUE) %>%
  list() %>%
  st_polygon() %>%
  st_sfc() %>%
  st_set_crs(4326) %>%
  sf_as_ee()


# Get the mean annual NDVI for 2011
cloudMaskL457 <- function(image) {
  qa <- image$select("pixel_qa")
  cloud <- qa$bitwiseAnd(32L)$
    And(qa$bitwiseAnd(128L))$
    Or(qa$bitwiseAnd(8L))
  mask2 <- image$mask()$reduce(ee$Reducer$min())
  image <- image$updateMask(cloud$Not())$updateMask(mask2)
  image$normalizedDifference(list("B4", "B3"))
}

ic_l5 <- ee$ImageCollection("LANDSAT/LT05/C01/T1_SR")$
  filterBounds(ee$FeatureCollection(ee_ROI))$
  filterDate("2011-01-01", "2011-12-31")$
  map(cloudMaskL457)

# Create simple composite
mean_l5 <- ic_l5$mean()$rename("NDVI")
mean_l5 <- mean_l5$reproject(crs = "EPSG:4326", scale = 500)
mean_l5_Amarakaeri <- mean_l5$clip(ee_ROI)

# Move results from Earth Engine to GoogleDrive (not to local storage yet!)
task_img <- ee_image_to_drive(
  image = mean_l5_Amarakaeri,
  fileFormat = "GEO_TIFF",
  region = ee_ROI,
  fileNamePrefix = "my_image_demo",
  folder = "rgee_backup"
)

task_img$start()
ee_monitoring(task_img)

# Move results from Drive to local storage
ee_drive_to_local(
  task = task_img,
  dsn  = here("test.tif")
  )

## End(Not run)
```

```{r}
# Plot data
ndvi_raster <- raster(here("test.tif"))
# plot(ndvi_raster, main = "NDVI 2005-2006")
```

```{r}
df_ndvi <- as.data.frame(ndvi_raster,xy = TRUE)
```

```{r}
ggplot() +
  geom_tile(
    data = xxx,
    aes(
      x = x,
      y = y,
      fill = NDVI
    )
  ) +
  xlim(-71.25, -70.85) +
  scale_fill_viridis_c(direction = -1) +
  theme_classic()
```
